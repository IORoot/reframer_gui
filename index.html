<!DOCTYPE html>
<html>
<head>
    <title>RF-1 Reframer - Video Reframing Tool</title>
    <link href="./styles.css" rel="stylesheet">
</head>
<body class="font-sans bg-gray-100 m-0 p-0 h-screen flex">
    <div class="flex w-full h-full">
        <!-- Left side: Video preview -->
        <div class="w-2/3 h-full p-5 flex flex-col">
            <div class="flex items-center gap-4 mb-4">
                <svg viewBox="0 0 115 47" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-6 w-auto">
                    <path d="M0.272727 47V0.454544H13.9091C16.5152 0.454544 18.8182 1.00757 20.8182 2.11364C22.8333 3.21969 24.4091 4.76515 25.5455 6.75C26.697 8.73485 27.2727 11.0606 27.2727 13.7273C27.2727 16.3636 26.697 18.6742 25.5455 20.6591C24.4091 22.6288 22.8333 24.1667 20.8182 25.2727C18.8182 26.3636 16.5152 26.9091 13.9091 26.9091H1V25.4545H13.9091C16.2424 25.4545 18.303 24.9697 20.0909 24C21.8788 23.0303 23.2803 21.6667 24.2955 19.9091C25.3106 18.1515 25.8182 16.0909 25.8182 13.7273C25.8182 11.3485 25.3106 9.27273 24.2955 7.5C23.2803 5.72727 21.8788 4.35606 20.0909 3.38636C18.303 2.40151 16.2424 1.90909 13.9091 1.90909H1.72727V47H0.272727ZM18 25.8182L29.4545 47H27.8182L16.3636 25.8182H18ZM39.6477 47V0.454544H64.6477V1.90909H41.1023V23H62.4659V24.4545H41.1023V47H39.6477ZM92.5398 23V24.4545H75.1761V23H92.5398ZM114.148 0.454544V47H112.693V2H112.42L102.42 8.63636V6.90909L112.148 0.454544H114.148Z" fill="#3D394D"/>
                </svg>
                <h1 class="text-2xl font-bold m-0 text-gray-700">Reframer <span>v1.0.0</span></h1>
            </div>
            
            <!-- Video preview container -->
            <div id="videoPreview" class="flex-1 flex flex-col">
                <div class="bg-stone-900 p-8 rounded-lg flex-1 flex flex-col">
                    <!-- Video tabs navigation -->
                    <div class="border-b border-gray-700 mb-4">
                        <nav class="flex" aria-label="Video Tabs">
                            <button class="video-tab-button flex-1 py-2 px-4 border-b-2 border-blue-500 font-medium text-sm text-blue-400 text-center" data-tab="input">
                                Input Video
                            </button>
                            <button class="video-tab-button flex-1 py-2 px-4 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300 hover:border-gray-600 text-center" data-tab="output">
                                Output Video
                            </button>
                        </nav>
                    </div>

                    <!-- Video tab content -->
                    <div class="video-tab-content flex-1 flex flex-col">
                        <!-- Input video tab -->
                        <div id="input-video-tab" class="video-tab-pane flex-1 flex flex-col">
                            <div class="relative bg-black rounded-lg overflow-hidden group flex-1" style="aspect-ratio: 16/9;">
                                <div class="absolute inset-0"></div>
                                <video id="previewVideo" class="w-full h-full object-contain hidden" preload="metadata" controls>
                                    Your browser does not support the video tag.
                                </video>
                                <button id="playPauseOverlay" class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center bg-black bg-opacity-30 opacity-0 group-hover:opacity-100 transition-opacity duration-200 cursor-pointer hidden rounded-full hover:bg-opacity-40">
                                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                            </div>
                            <div id="videoInfo" class="mt-2 bg-gray-100 rounded-lg p-2 text-sm text-gray-700 font-mono hidden">
                                <span id="videoResolution"></span>
                                <span class="mx-2">•</span>
                                <span id="videoFps"></span>
                                <span class="mx-2">•</span>
                                <span id="videoDuration"></span>
                                <span class="mx-2">•</span>
                                <span id="videoSize"></span>
                            </div>
                        </div>

                        <!-- Output video tab -->
                        <div id="output-video-tab" class="video-tab-pane hidden flex-1 flex flex-col">
                            <div class="relative bg-black rounded-lg overflow-hidden group flex-1" style="aspect-ratio: 16/9;">
                                <div class="absolute inset-0"></div>
                                <video id="outputVideo" class="w-full h-full object-contain hidden" preload="metadata" controls>
                                    Your browser does not support the video tag.
                                </video>
                                <button id="outputPlayPauseOverlay" class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center bg-black bg-opacity-30 opacity-0 group-hover:opacity-100 transition-opacity duration-200 cursor-pointer hidden rounded-full hover:bg-opacity-40">
                                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                            </div>
                            <div id="outputVideoInfo" class="mt-2 bg-gray-100 rounded-lg p-2 text-sm text-gray-700 font-mono hidden">
                                <span id="outputVideoResolution"></span>
                                <span class="mx-2">•</span>
                                <span id="outputVideoFps"></span>
                                <span class="mx-2">•</span>
                                <span id="outputVideoDuration"></span>
                                <span class="mx-2">•</span>
                                <span id="outputVideoSize"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right side: Settings panel -->
        <div class="w-1/3 h-full bg-white border-l border-gray-200 flex flex-col">
            <!-- Status notification -->
            <div id="status" class="hidden p-2.5 border-b border-gray-200"></div>

            <!-- File selection section -->
            <div class="p-5 border-b border-gray-200">
                <!-- Input type tabs -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex" aria-label="Input Type Tabs">
                        <button class="input-type-tab-button flex-1 py-2 px-4 border-b-2 border-blue-500 font-medium text-sm text-blue-600 text-center" data-tab="single">
                            Single Video
                        </button>
                        <button class="input-type-tab-button flex-1 py-2 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center" data-tab="batch">
                            Batch Processing
                        </button>
                    </nav>
                </div>

                <!-- Input type content -->
                <div class="input-type-content">
                    <!-- Single video input -->
                    <div id="single-input-tab" class="input-type-pane">
                        <div class="space-y-2.5">
                            <div class="flex items-center gap-2.5">
                                <input type="text" id="filePath" readonly placeholder="Select a video file..." class="flex-grow px-2 py-2 border border-gray-300 rounded bg-gray-50">
                                <button id="selectFile" class="btn btn-primary">Browse</button>
                            </div>
                            <div class="flex items-center gap-2.5">
                                <input type="text" id="outputDir" readonly placeholder="Select output directory..." class="flex-grow px-2 py-2 border border-gray-300 rounded bg-gray-50">
                                <button id="selectOutputDir" class="btn btn-primary">Browse</button>
                            </div>
                            <div class="flex items-center gap-2.5">
                                <label for="outputFilename" class="min-w-[150px] font-medium">Output Filename:</label>
                                <input type="text" id="outputFilename" placeholder="Enter output filename (without extension)" class="input flex-grow">
                                <span class="text-sm text-gray-600 italic">(Optional)</span>
                            </div>
                            <div class="flex gap-2.5">
                                <button id="processButton" disabled class="btn btn-primary flex-grow disabled:bg-gray-300 disabled:cursor-not-allowed">Process Video</button>
                                <button id="cancelButton" class="btn btn-secondary hidden">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Batch processing input -->
                    <div id="batch-input-tab" class="input-type-pane hidden">
                        <!-- Batch progress header -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold">Batch Progress</h3>
                                <div class="flex items-center gap-2">
                                    <button id="startBatch" class="btn btn-primary" disabled>Start Batch</button>
                                    <button id="pauseBatch" class="btn btn-secondary hidden">Pause</button>
                                    <button id="clearBatch" class="btn btn-secondary">Clear Queue</button>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <div class="text-sm text-gray-600 mb-1">Overall Progress</div>
                                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div id="batchProgressBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span id="batchProgressText">0/0 videos</span>
                                </div>
                            </div>
                        </div>

                        <!-- File selection controls -->
                        <div class="flex gap-2.5 mb-4">
                            <button id="selectBatchFiles" class="btn btn-primary flex-1">Select Multiple Files</button>
                            <button id="selectBatchFolder" class="btn btn-primary flex-1">Select Folder</button>
                            <div class="flex items-center gap-2 px-3 bg-gray-50 rounded border border-gray-200">
                                <input type="checkbox" id="recursiveSearch" class="m-0">
                                <label for="recursiveSearch" class="text-sm text-gray-600">Search subfolders</label>
                            </div>
                        </div>

                        <!-- Queue list -->
                        <div id="batchQueue" class="space-y-2 max-h-[200px] overflow-y-auto">
                            <!-- Queue items will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings section -->
            <div class="flex-1 overflow-y-auto">
                <div class="p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Processing Settings</h2>
                    </div>
                    
                    <!-- Tabs navigation -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex justify-between" aria-label="Settings Tabs">
                            <button class="tab-button flex-1 py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 text-center" data-tab="basic">
                                Basic
                            </button>
                            <button class="tab-button flex-1 py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center" data-tab="detection">
                                Detection
                            </button>
                            <button class="tab-button flex-1 py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center" data-tab="crop">
                                Cropping
                            </button>
                            <button class="tab-button flex-1 py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center" data-tab="features">
                                Features
                            </button>
                            <button class="tab-button flex-1 py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center" data-tab="smoothing">
                                Smoothing
                            </button>
                            <button class="tab-button flex-1 py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center" data-tab="debug">
                                Debug
                            </button>
                        </nav>
                    </div>

                    <!-- Tab content -->
                    <div class="tab-content">
                        <!-- Basic Settings Tab -->
                        <div id="basic-tab" class="tab-pane">
                            <div class="space-y-2.5">
                                <div class="flex items-center gap-2.5">
                                    <label for="targetRatio" class="min-w-[150px] font-medium">Target Aspect Ratio:</label>
                                    <input type="number" id="targetRatio" value="0.75" step="0.01" min="0.1" max="2.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(0.75 = 4:3, 0.5625 = 16:9, 1.0 = 1:1)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label class="min-w-[150px] font-medium">Calculate Ratio:</label>
                                    <div class="flex items-center gap-3 bg-gray-50 p-2 rounded border border-gray-200">
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="widthInput" placeholder="Width" class="input w-28 bg-white" min="1">
                                            <span class="text-gray-600 font-medium">×</span>
                                            <input type="number" id="heightInput" placeholder="Height" class="input w-28 bg-white" min="1">
                                        </div>
                                        <button id="calculateRatio" class="btn btn-secondary text-sm px-4 ml-2">Calculate</button>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="maxWorkers" class="min-w-[150px] font-medium">Max Workers:</label>
                                    <input type="number" id="maxWorkers" value="6" min="1" max="32" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Number of CPU cores to use)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Detection Settings Tab -->
                        <div id="detection-tab" class="tab-pane hidden">
                            <div class="space-y-2.5">
                                <div class="flex items-center gap-2.5">
                                    <label for="detector" class="min-w-[150px] font-medium">Detector Model:</label>
                                    <select id="detector" class="input w-24 bg-white" disabled>
                                        <option value="yolo" selected>YOLO</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="skipFrames" class="min-w-[150px] font-medium">Skip Frames:</label>
                                    <input type="number" id="skipFrames" value="10" min="0" max="100" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Process every Nth frame)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="confThreshold" class="min-w-[150px] font-medium">Confidence Threshold:</label>
                                    <input type="number" id="confThreshold" value="0.4" step="0.1" min="0.1" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(0.0 to 1.0)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="modelSize" class="min-w-[150px] font-medium">Model Size:</label>
                                    <select id="modelSize" class="input w-24 bg-white">
                                        <option value="n">Nano (Fastest)</option>
                                        <option value="s">Small</option>
                                        <option value="m">Medium</option>
                                        <option value="l">Large</option>
                                        <option value="x" selected>XLarge (Most Accurate)</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="objectClasses" class="min-w-[150px] font-medium">Object Classes:</label>
                                    <input type="text" id="objectClasses" value="0" placeholder="0,1,2" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Comma-separated, 0=person)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="trackCount" class="min-w-[150px] font-medium">Track Count:</label>
                                    <input type="number" id="trackCount" value="1" min="1" max="10" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Number of objects to track)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Crop Settings Tab -->
                        <div id="crop-tab" class="tab-pane hidden">
                            <div class="space-y-2.5">
                                <div class="flex items-center gap-2.5">
                                    <label for="paddingRatio" class="min-w-[150px] font-medium">Padding Ratio:</label>
                                    <input type="number" id="paddingRatio" value="0.1" step="0.01" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Space around detected objects)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="sizeWeight" class="min-w-[150px] font-medium">Size Weight:</label>
                                    <input type="number" id="sizeWeight" value="0.4" step="0.1" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Importance of object size)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="centerWeight" class="min-w-[150px] font-medium">Center Weight:</label>
                                    <input type="number" id="centerWeight" value="0.3" step="0.1" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Importance of center position)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="motionWeight" class="min-w-[150px] font-medium">Motion Weight:</label>
                                    <input type="number" id="motionWeight" value="0.3" step="0.1" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Importance of object motion)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="historyWeight" class="min-w-[150px] font-medium">History Weight:</label>
                                    <input type="number" id="historyWeight" value="0.1" step="0.1" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Importance of object history)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="saliencyWeight" class="min-w-[150px] font-medium">Saliency Weight:</label>
                                    <input type="number" id="saliencyWeight" value="0.4" step="0.1" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Importance of visual saliency)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Feature Toggles Tab -->
                        <div id="features-tab" class="tab-pane hidden">
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2.5">
                                    <input type="checkbox" id="faceDetection" class="m-0">
                                    <label for="faceDetection" class="ml-1.5">Face Detection</label>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <input type="checkbox" id="weightedCenter" class="m-0">
                                    <label for="weightedCenter" class="ml-1.5">Weighted Center</label>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <input type="checkbox" id="blendSaliency" class="m-0">
                                    <label for="blendSaliency" class="ml-1.5">Blend Saliency</label>
                                </div>
                            </div>
                        </div>

                        <!-- Smoothing Settings Tab -->
                        <div id="smoothing-tab" class="tab-pane hidden">
                            <div class="space-y-2.5">
                                <div class="flex items-center gap-2.5">
                                    <input type="checkbox" id="applySmoothing" checked class="m-0">
                                    <label for="applySmoothing" class="ml-1.5">Apply Temporal Smoothing</label>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="smoothingWindow" class="min-w-[150px] font-medium">Smoothing Window:</label>
                                    <input type="number" id="smoothingWindow" value="30" min="1" max="100" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(Frames for smoothing)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="positionInertia" class="min-w-[150px] font-medium">Position Inertia:</label>
                                    <input type="number" id="positionInertia" value="0.8" step="0.1" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(How much position sticks to previous frame)</span>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <label for="sizeInertia" class="min-w-[150px] font-medium">Size Inertia:</label>
                                    <input type="number" id="sizeInertia" value="0.9" step="0.1" min="0" max="1.0" class="input w-24">
                                    <span class="text-sm text-gray-600 italic">(How much size sticks to previous frame)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Debug Tab -->
                        <div id="debug-tab" class="tab-pane hidden">
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2.5">
                                    <input type="checkbox" id="debug" class="m-0">
                                    <label for="debug" class="ml-1.5">Debug Mode</label>
                                </div>
                                <div class="flex items-center gap-2.5">
                                    <input type="checkbox" id="showHelp" class="m-0">
                                    <label for="showHelp" class="ml-1.5">Show Help Messages</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug panel (collapsible) -->
            <div class="debug-panel hidden border-t border-gray-200">
                <div class="flex justify-between items-center p-2.5 bg-[#2d2d2d] border-b border-gray-200">
                    <h3 class="m-0 text-white text-base">Python Output</h3>
                    <div class="flex items-center gap-2">
                        <button id="toggleDebug" class="px-2 py-1 bg-[#444] text-white border-none rounded cursor-pointer text-sm hover:bg-[#555]">Collapse</button>
                        <button id="clearDebug" class="px-2 py-1 bg-[#444] text-white border-none rounded cursor-pointer text-sm hover:bg-[#555]">Clear</button>
                    </div>
                </div>
                <pre id="debugOutput" class="m-0 p-4 max-h-[200px] overflow-y-auto whitespace-pre-wrap break-words text-sm leading-relaxed bg-[#1e1e1e] text-[#d4d4d4] font-mono"></pre>
            </div>
        </div>
    </div>

    <script>
        const selectFileButton = document.getElementById('selectFile');
        const selectOutputDirButton = document.getElementById('selectOutputDir');
        const processButton = document.getElementById('processButton');
        const filePathInput = document.getElementById('filePath');
        const outputDirInput = document.getElementById('outputDir');
        const outputFilenameInput = document.getElementById('outputFilename');
        const statusDiv = document.getElementById('status');
        const cancelButton = document.getElementById('cancelButton');
        let currentProcess = null;

        function showStatus(message, type) {
            statusDiv.innerHTML = message.replace(/\n/g, '<br>');
            statusDiv.classList.remove('hidden');
            statusDiv.className = `p-2.5 border-b border-gray-200 ${
                type === 'success' ? 'bg-green-50 text-green-800' : 
                type === 'error' ? 'bg-red-50 text-red-800' : 
                'bg-yellow-50 text-yellow-800'
            }`;
        }

        // Helper function to calculate FPS
        function calculateFPS(video) {
            // Try to get FPS from video metadata
            if (video.mozFrameRate) {
                // Firefox
                return video.mozFrameRate;
            }
            
            // Try to get FPS from video track
            const videoTrack = video.videoTracks?.[0];
            if (videoTrack?.getSettings?.()?.frameRate) {
                return videoTrack.getSettings().frameRate;
            }
            
            // Try to get FPS from webkit properties
            if (video.webkitVideoDecodedByteCount && video.duration) {
                // This is a rough estimate based on decoded bytes
                const bytesPerFrame = video.videoWidth * video.videoHeight * 1.5; // Assuming YUV420 format
                const totalFrames = video.webkitVideoDecodedByteCount / bytesPerFrame;
                return totalFrames / video.duration;
            }
            
            // Default to 30fps if we can't determine
            return 30;
        }

        // Update video preview functionality
        async function updateVideoPreview(videoPath) {
            const previewVideo = document.getElementById('previewVideo');
            const videoResolution = document.getElementById('videoResolution');
            const videoDuration = document.getElementById('videoDuration');
            const videoFps = document.getElementById('videoFps');
            const videoSize = document.getElementById('videoSize');
            const playPauseOverlay = document.getElementById('playPauseOverlay');

            try {
                // Create a File object from the path
                const response = await fetch(`file://${videoPath}`);
                const blob = await response.blob();
                const file = new File([blob], videoPath.split('/').pop(), { type: blob.type });
                
                // Create object URL for the video
                const videoUrl = URL.createObjectURL(file);
                previewVideo.src = videoUrl;
                
                // Show video element and play/pause overlay
                previewVideo.classList.remove('hidden');
                playPauseOverlay.classList.remove('hidden');
                
                // Wait for metadata to load
                await new Promise((resolve) => {
                    previewVideo.onloadedmetadata = () => {
                        // Show video info panel
                        document.getElementById('videoInfo').classList.remove('hidden');
                        
                        // Update video info
                        videoResolution.textContent = `${previewVideo.videoWidth}×${previewVideo.videoHeight}`;
                        
                        // Format duration as minutes:seconds
                        const minutes = Math.floor(previewVideo.duration / 60);
                        const seconds = Math.floor(previewVideo.duration % 60);
                        videoDuration.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Calculate FPS
                        let fps = calculateFPS(previewVideo);
                        // Round to nearest standard frame rate
                        const standardRates = [23.976, 24, 25, 29.97, 30, 50, 59.94, 60];
                        const closest = standardRates.reduce((prev, curr) => {
                            return Math.abs(curr - fps) < Math.abs(prev - fps) ? curr : prev;
                        });
                        fps = closest;
                        videoFps.textContent = `${fps.toFixed(2)} fps`;
                        
                        // Format size with more precision
                        const sizeMB = file.size / (1024 * 1024);
                        videoSize.textContent = sizeMB >= 1000 
                            ? `${(sizeMB / 1024).toFixed(2)} GB`
                            : `${sizeMB.toFixed(2)} MB`;
                        
                        resolve();
                    };
                });

                // Add play/pause overlay functionality
                playPauseOverlay.addEventListener('click', async () => {
                    try {
                        if (previewVideo.paused) {
                            await previewVideo.play();
                            playPauseOverlay.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
                        } else {
                            previewVideo.pause();
                            playPauseOverlay.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>';
                        }
                    } catch (error) {
                        console.error('Error playing video:', error);
                    }
                });

                // Update overlay button when video plays/pauses
                previewVideo.addEventListener('play', () => {
                    playPauseOverlay.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
                });
                previewVideo.addEventListener('pause', () => {
                    playPauseOverlay.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>';
                });
                
                // Clean up object URL when video is unloaded
                previewVideo.onunload = () => {
                    URL.revokeObjectURL(videoUrl);
                    previewVideo.classList.add('hidden');
                    playPauseOverlay.classList.add('hidden');
                    document.getElementById('videoInfo').classList.add('hidden');
                };
            } catch (error) {
                console.error('Error updating video preview:', error);
                previewVideo.classList.add('hidden');
                playPauseOverlay.classList.add('hidden');
                document.getElementById('videoInfo').classList.add('hidden');
            }
        }

        // Update file selection handler
        selectFileButton.addEventListener('click', async () => {
            const filePath = await window.electronAPI.selectFile();
            if (filePath) {
                filePathInput.value = filePath;
                // Set default output directory to same as input file
                const defaultOutputDir = filePath.substring(0, filePath.lastIndexOf('/'));
                outputDirInput.value = defaultOutputDir;
                await updateVideoPreview(filePath);
                processButton.disabled = false;
            }
        });

        selectOutputDirButton.addEventListener('click', async () => {
            const dirPath = await window.electronAPI.selectDirectory();
            if (dirPath) {
                outputDirInput.value = dirPath;
            }
        });

        // Add event listeners for all settings
        const settings = {
            targetRatio: document.getElementById('targetRatio'),
            maxWorkers: document.getElementById('maxWorkers'),
            detector: document.getElementById('detector'),
            skipFrames: document.getElementById('skipFrames'),
            confThreshold: document.getElementById('confThreshold'),
            modelSize: document.getElementById('modelSize'),
            objectClasses: document.getElementById('objectClasses'),
            trackCount: document.getElementById('trackCount'),
            paddingRatio: document.getElementById('paddingRatio'),
            sizeWeight: document.getElementById('sizeWeight'),
            centerWeight: document.getElementById('centerWeight'),
            motionWeight: document.getElementById('motionWeight'),
            historyWeight: document.getElementById('historyWeight'),
            saliencyWeight: document.getElementById('saliencyWeight'),
            faceDetection: document.getElementById('faceDetection'),
            weightedCenter: document.getElementById('weightedCenter'),
            blendSaliency: document.getElementById('blendSaliency'),
            applySmoothing: document.getElementById('applySmoothing'),
            smoothingWindow: document.getElementById('smoothingWindow'),
            positionInertia: document.getElementById('positionInertia'),
            sizeInertia: document.getElementById('sizeInertia'),
            debug: document.getElementById('debug')
        };

        const debugPanel = document.querySelector('.debug-panel');
        const debugOutput = document.getElementById('debugOutput');
        const toggleDebugButton = document.getElementById('toggleDebug');
        let isDebugExpanded = true;

        toggleDebugButton.addEventListener('click', () => {
            isDebugExpanded = !isDebugExpanded;
            debugOutput.style.display = isDebugExpanded ? 'block' : 'none';
            toggleDebugButton.textContent = isDebugExpanded ? 'Collapse' : 'Expand';
        });

        // Update debug panel visibility when debug mode is toggled
        settings.debug.addEventListener('change', (e) => {
            const debugPanel = document.querySelector('.debug-panel');
            const debugOutput = document.getElementById('debugOutput');
            const toggleDebugButton = document.getElementById('toggleDebug');
            
            debugPanel.classList.toggle('hidden', !e.target.checked);
            if (e.target.checked) {
                isDebugExpanded = true;
                debugOutput.style.display = 'block';
                toggleDebugButton.textContent = 'Collapse';
                // Show debug panel immediately when enabled
                debugPanel.classList.remove('hidden');
            }
        });

        // Add clear debug button event listener
        document.getElementById('clearDebug').addEventListener('click', () => {
            clearDebugOutput();
        });

        // Global variable to track current Python handlers
        let currentPythonHandlers = null;
        let isProcessing = false;

        // Function to clean up Python output handlers
        function cleanupPythonHandlers() {
            if (currentPythonHandlers) {
                // Remove both output and complete handlers
                window.electronAPI.removePythonOutputListener(currentPythonHandlers.pythonOutputHandler);
                window.electronAPI.removePythonScriptCompleteListener(currentPythonHandlers.scriptCompleteHandler);
                currentPythonHandlers = null;
            }
            isProcessing = false;
        }

        // Function to set up Python output handlers
        function setupPythonHandlers() {
            // Clean up any existing handlers first
            cleanupPythonHandlers();
            
            // Only set up new handlers if we're not already processing
            if (!isProcessing) {
                isProcessing = true;
                
                const pythonOutputHandler = (event, message) => {
                    if (isProcessing) {  // Only append output if we're still processing
                        appendDebugOutput(message, 'info');
                    }
                };
                
                const scriptCompleteHandler = (event, result) => {
                    // Clean up handlers immediately when script completes
                    cleanupPythonHandlers();
                    
                    if (result.success) {
                        showStatus(`Video processing completed successfully!\nOutput saved to: ${result.outputPath}`, 'success');
                        appendDebugOutput('Processing completed successfully!', 'success');
                        appendDebugOutput(`Output saved to: ${result.outputPath}`, 'success');
                        
                        // If in single video mode, load the output video
                        if (!isBatchProcessing) {
                            loadOutputVideo(result.outputPath).then(() => {
                                switchVideoTab('output');
                            });
                        } else {
                            // Update batch queue item status
                            const video = batchQueue[currentBatchIndex];
                            if (video) {
                                video.status = 'completed';
                                video.progress = 100;
                                updateQueueItemStatus(video.path, 'completed', 100);
                                updateBatchProgress();
                            }
                        }
                    } else {
                        showStatus(`Error: ${result.error}`, 'error');
                        appendDebugOutput(`Error: ${result.error}`, 'error');
                        if (result.stack) {
                            appendDebugOutput(result.stack, 'error');
                        }
                        
                        // If in batch mode, update queue item status
                        if (isBatchProcessing) {
                            const video = batchQueue[currentBatchIndex];
                            if (video) {
                                video.status = 'failed';
                                updateQueueItemStatus(video.path, 'failed', 0, result.error);
                                updateBatchProgress();
                            }
                        }
                    }

                    // Reset UI state if in single video mode
                    if (!isBatchProcessing) {
                        processButton.classList.remove('hidden');
                        cancelButton.classList.add('hidden');
                        processButton.disabled = false;
                        selectFileButton.disabled = false;
                        selectOutputDirButton.disabled = false;
                        outputFilenameInput.disabled = false;
                        currentProcess = null;
                    } else {
                        // Process next video in batch if not paused
                        if (isBatchProcessing) {
                            processNextVideo();
                        }
                    }
                };

                // Set up new handlers
                window.electronAPI.onPythonOutput(pythonOutputHandler);
                window.electronAPI.onPythonScriptComplete(scriptCompleteHandler);
                
                // Store current handlers
                currentPythonHandlers = { pythonOutputHandler, scriptCompleteHandler };
            }
        }

        // Add settings help text
        const settingsHelp = {
            targetRatio: "The desired aspect ratio for the output video. Common values: 0.75 (4:3), 0.5625 (16:9), 1.0 (1:1). The script will try to maintain this ratio while keeping important content in frame.",
            maxWorkers: "Number of CPU cores to use for parallel processing. Higher values may improve speed but will use more system resources. Recommended: 4-8 for most systems.",
            detector: "The object detection model to use. Currently only YOLO is supported, which is optimized for detecting people and common objects.",
            skipFrames: "Process every Nth frame to speed up processing. Higher values are faster but may miss rapid movements. Recommended: 5-15 for most videos.",
            confThreshold: "Minimum confidence score (0.0-1.0) required for object detection. Higher values are more selective but may miss objects. Lower values detect more objects but may include false positives.",
            modelSize: "Size of the YOLO model to use. Larger models are more accurate but slower. Options: Nano (fastest), Small, Medium, Large, XLarge (most accurate).",
            objectClasses: "Comma-separated list of object classes to detect. 0=person, 1=bicycle, etc. See YOLO documentation for full list. Default (0) detects people only.",
            trackCount: "Maximum number of objects to track simultaneously. Higher values may improve tracking of multiple subjects but use more resources.",
            paddingRatio: "Additional space to add around detected objects (0.0-1.0). Higher values give more context but may include unwanted areas.",
            sizeWeight: "Importance of object size in crop decisions (0.0-1.0). Higher values prioritize keeping objects large in frame.",
            centerWeight: "Importance of object position in crop decisions (0.0-1.0). Higher values try to keep objects centered.",
            motionWeight: "Importance of object movement in crop decisions (0.0-1.0). Higher values prioritize tracking moving objects.",
            historyWeight: "Importance of previous frame positions (0.0-1.0). Higher values make cropping more stable but less responsive to movement.",
            saliencyWeight: "Importance of visual saliency in crop decisions (0.0-1.0). Higher values try to keep visually interesting areas in frame.",
            faceDetection: "Enable additional face detection to prioritize keeping faces in frame. Useful for videos with people. However, it can cause issues with tracking correctly.",
            weightedCenter: "Use weighted center calculation based on object size and position. Helps balance the frame when there are multiple subjects.",
            blendSaliency: "Blend saliency map with object detection for better composition. May help keep visually important areas in frame.",
            applySmoothing: "Apply temporal smoothing to crop window movement. Reduces jitter but may make tracking less responsive.",
            smoothingWindow: "Number of frames to use for smoothing (1-100). Higher values make movement smoother but may lag behind rapid changes.",
            positionInertia: "How much the crop position sticks to previous frames (0.0-1.0). Higher values reduce jitter but may lag behind movement.",
            sizeInertia: "How much the crop size sticks to previous frames (0.0-1.0). Higher values make size changes smoother but may lag behind.",
            debug: "Enable detailed debug output showing processing steps and decisions."
        };

        // Add help text to settings
        function addHelpTextToSettings() {
            // Get all setting elements
            const settingElements = {
                targetRatio: document.getElementById('targetRatio'),
                maxWorkers: document.getElementById('maxWorkers'),
                detector: document.getElementById('detector'),
                skipFrames: document.getElementById('skipFrames'),
                confThreshold: document.getElementById('confThreshold'),
                modelSize: document.getElementById('modelSize'),
                objectClasses: document.getElementById('objectClasses'),
                trackCount: document.getElementById('trackCount'),
                paddingRatio: document.getElementById('paddingRatio'),
                sizeWeight: document.getElementById('sizeWeight'),
                centerWeight: document.getElementById('centerWeight'),
                motionWeight: document.getElementById('motionWeight'),
                historyWeight: document.getElementById('historyWeight'),
                saliencyWeight: document.getElementById('saliencyWeight'),
                faceDetection: document.getElementById('faceDetection'),
                weightedCenter: document.getElementById('weightedCenter'),
                blendSaliency: document.getElementById('blendSaliency'),
                applySmoothing: document.getElementById('applySmoothing'),
                smoothingWindow: document.getElementById('smoothingWindow'),
                positionInertia: document.getElementById('positionInertia'),
                sizeInertia: document.getElementById('sizeInertia')
            };

            // Add help text elements and toggle visibility
            Object.entries(settingElements).forEach(([key, element]) => {
                if (!element) return;

                // Find the parent container (usually a div with flex items-center gap-2.5)
                const container = element.closest('.flex.items-center.gap-2\\.5');
                if (!container) return;

                // Create help text element
                const helpText = document.createElement('div');
                helpText.className = 'help-text text-sm text-gray-600 mt-1 ml-[150px] hidden';
                helpText.textContent = settingsHelp[key];
                helpText.id = `${key}-help`;

                // Insert help text after the container
                container.parentNode.insertBefore(helpText, container.nextSibling);
            });
        }

        // Function to toggle help text visibility
        function toggleHelpText(show) {
            const helpTexts = document.querySelectorAll('.help-text');
            helpTexts.forEach(help => {
                help.classList.toggle('hidden', !show);
            });
        }

        // Add help text toggle handler
        document.getElementById('showHelp').addEventListener('change', (e) => {
            toggleHelpText(e.target.checked);
        });

        // Initialize help text system
        addHelpTextToSettings();

        // Update logSettingsToDebug to include help text when enabled
        function logSettingsToDebug(options) {
            appendDebugOutput('Processing Settings:', 'info');
            appendDebugOutput('-------------------', 'info');
            
            // Log all settings in a readable format
            const settings = [
                ['Input Video', options.input_path],
                ['Output Directory', options.output_dir],
                ['Output Filename', options.output_filename || '(auto-generated)'],
                ['Target Aspect Ratio', options.target_ratio],
                ['Max Workers', options.max_workers],
                ['Detector Model', options.detector],
                ['Skip Frames', options.skip_frames],
                ['Confidence Threshold', options.conf_threshold],
                ['Model Size', options.model_size],
                ['Object Classes', options.object_classes.join(', ')],
                ['Track Count', options.track_count],
                ['Padding Ratio', options.padding_ratio],
                ['Size Weight', options.size_weight],
                ['Center Weight', options.center_weight],
                ['Motion Weight', options.motion_weight],
                ['History Weight', options.history_weight],
                ['Saliency Weight', options.saliency_weight],
                ['Face Detection', options.face_detection ? 'Enabled' : 'Disabled'],
                ['Weighted Center', options.weighted_center ? 'Enabled' : 'Disabled'],
                ['Blend Saliency', options.blend_saliency ? 'Enabled' : 'Disabled'],
                ['Apply Smoothing', options.apply_smoothing ? 'Enabled' : 'Disabled'],
                ['Smoothing Window', options.smoothing_window],
                ['Position Inertia', options.position_inertia],
                ['Size Inertia', options.size_inertia],
                ['Debug Mode', options.debug ? 'Enabled' : 'Disabled']
            ];

            // Find the longest label for alignment
            const maxLabelLength = Math.max(...settings.map(([label]) => label.length));
            
            // Log each setting with aligned labels and help text if enabled
            settings.forEach(([label, value]) => {
                const paddedLabel = label.padEnd(maxLabelLength);
                appendDebugOutput(`${paddedLabel}: ${value}`, 'info');
                
                // Add help text if showHelp is enabled
                if (document.getElementById('showHelp').checked) {
                    const settingKey = label.toLowerCase().replace(/\s+/g, '');
                    if (settingsHelp[settingKey]) {
                        appendDebugOutput(`    ${settingsHelp[settingKey]}`, 'info');
                    }
                }
            });
            
            appendDebugOutput('-------------------', 'info');
            appendDebugOutput('Starting processing...', 'info');
            appendDebugOutput('', 'info'); // Add a blank line for readability
        }

        // Update process button click handler
        processButton.addEventListener('click', async () => {
            const videoPath = filePathInput.value;
            const outputDir = outputDirInput.value;
            const outputFilename = outputFilenameInput.value.trim();
            
            if (!videoPath || !outputDir) return;

            // Clean up any existing handlers before starting new process
            cleanupPythonHandlers();

            // Show cancel button and hide process button
            processButton.classList.add('hidden');
            cancelButton.classList.remove('hidden');
            
            // Disable all inputs
            processButton.disabled = true;
            selectFileButton.disabled = true;
            selectOutputDirButton.disabled = true;
            outputFilenameInput.disabled = true;
            
            showStatus('Processing video...', 'processing');
            clearDebugOutput();
            appendDebugOutput('Starting video processing...', 'info');

            try {
                // Set up handlers before starting process
                setupPythonHandlers();

                // Convert object classes string to array of numbers
                const objectClassesArray = settings.objectClasses.value.split(',').map(x => parseInt(x.trim()));

                // Show debug panel if debug mode is enabled
                if (settings.debug.checked) {
                    const debugPanel = document.querySelector('.debug-panel');
                    debugPanel.classList.remove('hidden');
                    isDebugExpanded = true;
                    document.getElementById('debugOutput').style.display = 'block';
                    document.getElementById('toggleDebug').textContent = 'Collapse';
                }

                // Prepare options object
                const options = {
                    input_path: videoPath,
                    output_dir: outputDir,
                    output_filename: outputFilename,
                    target_ratio: parseFloat(settings.targetRatio.value),
                    max_workers: parseInt(settings.maxWorkers.value),
                    detector: settings.detector.value,
                    skip_frames: parseInt(settings.skipFrames.value),
                    conf_threshold: parseFloat(settings.confThreshold.value),
                    model_size: settings.modelSize.value,
                    object_classes: objectClassesArray,
                    track_count: parseInt(settings.trackCount.value),
                    padding_ratio: parseFloat(settings.paddingRatio.value),
                    size_weight: parseFloat(settings.sizeWeight.value),
                    center_weight: parseFloat(settings.centerWeight.value),
                    motion_weight: parseFloat(settings.motionWeight.value),
                    history_weight: parseFloat(settings.historyWeight.value),
                    saliency_weight: parseFloat(settings.saliencyWeight.value),
                    face_detection: settings.faceDetection.checked,
                    weighted_center: settings.weightedCenter.checked,
                    blend_saliency: settings.blendSaliency.checked,
                    apply_smoothing: settings.applySmoothing.checked,
                    smoothing_window: parseInt(settings.smoothingWindow.value),
                    position_inertia: parseFloat(settings.positionInertia.value),
                    size_inertia: parseFloat(settings.sizeInertia.value),
                    debug: settings.debug.checked
                };

                // Log settings to debug window
                logSettingsToDebug(options);

                // Run the Python script
                currentProcess = await window.electronAPI.runPythonScript(videoPath, options);
            } catch (error) {
                // Clean up handlers on error
                cleanupPythonHandlers();

                if (error.code === 'PROCESS_CANCELLED') {
                    showStatus('Processing cancelled', 'error');
                    appendDebugOutput('Processing cancelled by user', 'error');
                } else {
                    const errorMessage = error.error || error.message || 'An unknown error occurred';
                    const errorDetails = error.stack ? `\n\nDetails: ${error.stack}` : '';
                    showStatus(`Error: ${errorMessage}${errorDetails}`, 'error');
                    appendDebugOutput(`Error: ${errorMessage}`, 'error');
                    if (error.stack) {
                        appendDebugOutput(error.stack, 'error');
                    }
                    console.error('Processing error:', error);
                }

                // Reset UI state
                processButton.classList.remove('hidden');
                cancelButton.classList.add('hidden');
                processButton.disabled = false;
                selectFileButton.disabled = false;
                selectOutputDirButton.disabled = false;
                outputFilenameInput.disabled = false;
                currentProcess = null;
            }
        });

        // Update cancel button handler
        cancelButton.addEventListener('click', async () => {
            appendDebugOutput('Cancelling processing...', 'info');
            try {
                // Clean up Python output handlers
                cleanupPythonHandlers();

                const result = await window.electronAPI.cancelProcessing();
                if (result.success) {
                    showStatus('Processing cancelled', 'error');
                    appendDebugOutput('Processing cancelled successfully', 'info');
                } else {
                    showStatus(`Failed to cancel: ${result.error}`, 'error');
                    appendDebugOutput(`Failed to cancel: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error cancelling: ${error.message}`, 'error');
                appendDebugOutput(`Error cancelling: ${error.message}`, 'error');
            }
        });

        // Add tab functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        function switchTab(tabId) {
            // Update tab buttons
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('border-blue-500', 'text-blue-600');
                    button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-600');
                    button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });

            // Update tab panes
            tabPanes.forEach(pane => {
                if (pane.id === `${tabId}-tab`) {
                    pane.classList.remove('hidden');
                } else {
                    pane.classList.add('hidden');
                }
            });
        }

        // Add click handlers for tabs
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Initialize with first tab
        switchTab('basic');

        // Update output video loading function
        async function loadOutputVideo(videoPath) {
            const outputVideo = document.getElementById('outputVideo');
            const outputResolution = document.getElementById('outputVideoResolution');
            const outputDuration = document.getElementById('outputVideoDuration');
            const outputFps = document.getElementById('outputVideoFps');
            const outputSize = document.getElementById('outputVideoSize');
            const outputPlayPauseOverlay = document.getElementById('outputPlayPauseOverlay');

            try {
                // Remove any existing event listeners
                const newPlayPauseOverlay = outputPlayPauseOverlay.cloneNode(true);
                outputPlayPauseOverlay.parentNode.replaceChild(newPlayPauseOverlay, outputPlayPauseOverlay);

                // Create a File object from the path
                const response = await fetch(`file://${videoPath}`);
                const blob = await response.blob();
                const file = new File([blob], videoPath.split('/').pop(), { type: blob.type });
                
                // Create object URL for the video
                const videoUrl = URL.createObjectURL(file);
                outputVideo.src = videoUrl;
                
                // Show video element and play/pause overlay
                outputVideo.classList.remove('hidden');
                newPlayPauseOverlay.classList.remove('hidden');
                
                // Wait for metadata to load
                await new Promise((resolve) => {
                    outputVideo.onloadedmetadata = () => {
                        // Show video info panel
                        document.getElementById('outputVideoInfo').classList.remove('hidden');
                        
                        // Update video info
                        outputResolution.textContent = `${outputVideo.videoWidth}×${outputVideo.videoHeight}`;
                        
                        // Format duration as minutes:seconds
                        const minutes = Math.floor(outputVideo.duration / 60);
                        const seconds = Math.floor(outputVideo.duration % 60);
                        outputDuration.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Calculate FPS
                        let fps = calculateFPS(outputVideo);
                        // Round to nearest standard frame rate
                        const standardRates = [23.976, 24, 25, 29.97, 30, 50, 59.94, 60];
                        const closest = standardRates.reduce((prev, curr) => {
                            return Math.abs(curr - fps) < Math.abs(prev - fps) ? curr : prev;
                        });
                        fps = closest;
                        outputFps.textContent = `${fps.toFixed(2)} fps`;
                        
                        // Format size with more precision
                        const sizeMB = file.size / (1024 * 1024);
                        outputSize.textContent = sizeMB >= 1000 
                            ? `${(sizeMB / 1024).toFixed(2)} GB`
                            : `${sizeMB.toFixed(2)} MB`;
                        
                        resolve();
                    };
                });

                // Add play/pause overlay functionality
                newPlayPauseOverlay.addEventListener('click', async () => {
                    try {
                        if (outputVideo.paused) {
                            await outputVideo.play();
                            newPlayPauseOverlay.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
                        } else {
                            outputVideo.pause();
                            newPlayPauseOverlay.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>';
                        }
                    } catch (error) {
                        console.error('Error playing video:', error);
                    }
                });

                // Update overlay button when video plays/pauses
                outputVideo.addEventListener('play', () => {
                    newPlayPauseOverlay.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
                });
                outputVideo.addEventListener('pause', () => {
                    newPlayPauseOverlay.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>';
                });
                
                // Clean up object URL when video is unloaded
                outputVideo.onunload = () => {
                    URL.revokeObjectURL(videoUrl);
                    outputVideo.classList.add('hidden');
                    newPlayPauseOverlay.classList.add('hidden');
                    document.getElementById('outputVideoInfo').classList.add('hidden');
                };
            } catch (error) {
                console.error('Error loading output video:', error);
                outputVideo.classList.add('hidden');
                outputPlayPauseOverlay.classList.add('hidden');
                document.getElementById('outputVideoInfo').classList.add('hidden');
                throw error;
            }
        }

        // Add video tab functionality
        const videoTabButtons = document.querySelectorAll('.video-tab-button');
        const videoTabPanes = document.querySelectorAll('.video-tab-pane');

        function switchVideoTab(tabId) {
            // Update tab buttons
            videoTabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('border-blue-500', 'text-blue-400');
                    button.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-300', 'hover:border-gray-600');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-400');
                    button.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-300', 'hover:border-gray-600');
                }
            });

            // Update tab panes
            videoTabPanes.forEach(pane => {
                if (pane.id === `${tabId}-video-tab`) {
                    pane.classList.remove('hidden');
                } else {
                    pane.classList.add('hidden');
                }
            });
        }

        // Add click handlers for video tabs
        videoTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchVideoTab(button.dataset.tab);
            });
        });

        // Initialize with input video tab
        switchVideoTab('input');

        // Function to append text to debug output
        function appendDebugOutput(text, type = 'info') {
            const debugPanel = document.querySelector('.debug-panel');
            const debugOutput = document.getElementById('debugOutput');
            
            // Show debug panel if it's hidden but debug mode is enabled
            if (settings.debug.checked && debugPanel.classList.contains('hidden')) {
                debugPanel.classList.remove('hidden');
            }
            
            const line = document.createElement('div');
            line.className = type;
            line.textContent = text;
            debugOutput.appendChild(line);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        // Function to clear debug output
        function clearDebugOutput() {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML = '';
        }

        // Batch Processing Functionality
        const batchQueue = [];
        let isBatchProcessing = false;
        let currentBatchIndex = -1;

        // Batch processing UI elements
        const startBatchButton = document.getElementById('startBatch');
        const pauseBatchButton = document.getElementById('pauseBatch');
        const clearBatchButton = document.getElementById('clearBatch');
        const selectBatchFilesButton = document.getElementById('selectBatchFiles');
        const selectBatchFolderButton = document.getElementById('selectBatchFolder');
        const recursiveSearchCheckbox = document.getElementById('recursiveSearch');
        const batchQueueContainer = document.getElementById('batchQueue');
        const batchProgressBar = document.getElementById('batchProgressBar');
        const batchProgressText = document.getElementById('batchProgressText');

        // Function to create a queue item element
        function createQueueItemElement(videoPath, status = 'pending') {
            const item = document.createElement('div');
            item.className = 'bg-white rounded-lg shadow-sm p-4';
            item.dataset.path = videoPath;
            
            const fileName = videoPath.split('/').pop();
            const statusColors = {
                pending: 'text-gray-500',
                processing: 'text-blue-500',
                completed: 'text-green-500',
                failed: 'text-red-500'
            };
            
            item.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">${fileName}</div>
                        <div class="text-xs text-gray-500 truncate">${videoPath}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm ${statusColors[status]}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-600 error-message hidden"></div>
            `;
            
            return item;
        }

        // Function to update queue item status
        function updateQueueItemStatus(videoPath, status, progress = 0, error = null) {
            const item = batchQueueContainer.querySelector(`[data-path="${videoPath}"]`);
            if (!item) return;

            const statusSpan = item.querySelector('span');
            const errorMessage = item.querySelector('.error-message');

            // Update status
            const statusColors = {
                pending: 'text-gray-500',
                processing: 'text-blue-500',
                completed: 'text-green-500',
                failed: 'text-red-500'
            };
            statusSpan.className = `text-sm ${statusColors[status]}`;
            statusSpan.textContent = status.charAt(0).toUpperCase() + status.slice(1);

            // Update error message if any
            if (error) {
                errorMessage.textContent = error;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }

        // Function to update batch progress
        function updateBatchProgress() {
            const total = batchQueue.length;
            const completed = batchQueue.filter(item => item.status === 'completed').length;
            const progress = total > 0 ? (completed / total) * 100 : 0;
            
            batchProgressBar.style.width = `${progress}%`;
            batchProgressText.textContent = `${completed}/${total} videos`;
        }

        // Function to add videos to queue
        function addVideosToQueue(videoPaths) {
            for (const path of videoPaths) {
                if (!batchQueue.some(item => item.path === path)) {
                    batchQueue.push({
                        path,
                        status: 'pending',
                        progress: 0
                    });
                    batchQueueContainer.appendChild(createQueueItemElement(path));
                }
            }
            updateBatchProgress();
            startBatchButton.disabled = batchQueue.length === 0;
        }

        // Function to process next video in queue
        async function processNextVideo() {
            if (currentBatchIndex >= batchQueue.length - 1) {
                // All videos processed
                isBatchProcessing = false;
                startBatchButton.classList.remove('hidden');
                pauseBatchButton.classList.add('hidden');
                showStatus('Batch processing completed!', 'success');
                return;
            }

            currentBatchIndex++;
            const video = batchQueue[currentBatchIndex];
            updateQueueItemStatus(video.path, 'processing');

            try {
                // Clean up any existing handlers before starting new process
                cleanupPythonHandlers();

                // Set up handlers before starting process
                setupPythonHandlers();

                // Get current settings
                const objectClassesArray = settings.objectClasses.value.split(',').map(x => parseInt(x.trim()));
                
                // Prepare options object
                const options = {
                    input_path: video.path,
                    output_dir: video.path.substring(0, video.path.lastIndexOf('/')),
                    output_filename: null, // Use default naming
                    target_ratio: parseFloat(settings.targetRatio.value),
                    max_workers: parseInt(settings.maxWorkers.value),
                    detector: settings.detector.value,
                    skip_frames: parseInt(settings.skipFrames.value),
                    conf_threshold: parseFloat(settings.confThreshold.value),
                    model_size: settings.modelSize.value,
                    object_classes: objectClassesArray,
                    track_count: parseInt(settings.trackCount.value),
                    padding_ratio: parseFloat(settings.paddingRatio.value),
                    size_weight: parseFloat(settings.sizeWeight.value),
                    center_weight: parseFloat(settings.centerWeight.value),
                    motion_weight: parseFloat(settings.motionWeight.value),
                    history_weight: parseFloat(settings.historyWeight.value),
                    saliency_weight: parseFloat(settings.saliencyWeight.value),
                    face_detection: settings.faceDetection.checked,
                    weighted_center: settings.weightedCenter.checked,
                    blend_saliency: settings.blendSaliency.checked,
                    apply_smoothing: settings.applySmoothing.checked,
                    smoothing_window: parseInt(settings.smoothingWindow.value),
                    position_inertia: parseFloat(settings.positionInertia.value),
                    size_inertia: parseFloat(settings.sizeInertia.value),
                    debug: settings.debug.checked
                };

                // Log settings to debug window
                logSettingsToDebug(options);

                // Process video with current settings
                await window.electronAPI.runPythonScript(video.path, options);
            } catch (error) {
                // Clean up handlers on error
                cleanupPythonHandlers();

                video.status = 'failed';
                updateQueueItemStatus(video.path, 'failed', 0, error.message);
                updateBatchProgress();
                
                // Process next video if not paused
                if (isBatchProcessing) {
                    processNextVideo();
                }
            }
        }

        // Event Listeners for batch processing
        selectBatchFilesButton.addEventListener('click', async () => {
            const filePaths = await window.electronAPI.selectMultipleFiles();
            if (filePaths && filePaths.length > 0) {
                addVideosToQueue(filePaths);
            }
        });

        selectBatchFolderButton.addEventListener('click', async () => {
            const dirPath = await window.electronAPI.selectDirectory();
            if (dirPath) {
                const recursive = recursiveSearchCheckbox.checked;
                const videoPaths = await window.electronAPI.getVideoFilesInDirectory(dirPath, recursive);
                if (videoPaths && videoPaths.length > 0) {
                    addVideosToQueue(videoPaths);
                }
            }
        });

        startBatchButton.addEventListener('click', () => {
            if (batchQueue.length === 0) return;
            
            // Show debug panel if debug mode is enabled
            if (settings.debug.checked) {
                const debugPanel = document.querySelector('.debug-panel');
                debugPanel.classList.remove('hidden');
                isDebugExpanded = true;
                document.getElementById('debugOutput').style.display = 'block';
                document.getElementById('toggleDebug').textContent = 'Collapse';
            }
            
            isBatchProcessing = true;
            currentBatchIndex = -1;
            startBatchButton.classList.add('hidden');
            pauseBatchButton.classList.remove('hidden');
            processNextVideo();
        });

        pauseBatchButton.addEventListener('click', () => {
            isBatchProcessing = false;
            startBatchButton.classList.remove('hidden');
            pauseBatchButton.classList.add('hidden');
            showStatus('Batch processing paused', 'info');
        });

        clearBatchButton.addEventListener('click', () => {
            if (isBatchProcessing) {
                isBatchProcessing = false;
                startBatchButton.classList.remove('hidden');
                pauseBatchButton.classList.add('hidden');
            }
            batchQueue.length = 0;
            currentBatchIndex = -1;
            batchQueueContainer.innerHTML = '';
            batchProgressBar.style.width = '0%';
            batchProgressText.textContent = '0/0 videos';
            startBatchButton.disabled = true;
        });

        // Add input type tab functionality
        const inputTypeTabButtons = document.querySelectorAll('.input-type-tab-button');
        const inputTypePanes = document.querySelectorAll('.input-type-pane');

        function switchInputTypeTab(tabId) {
            // Update tab buttons
            inputTypeTabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('border-blue-500', 'text-blue-600');
                    button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-600');
                    button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });

            // Update tab panes
            inputTypePanes.forEach(pane => {
                if (pane.id === `${tabId}-input-tab`) {
                    pane.classList.remove('hidden');
                } else {
                    pane.classList.add('hidden');
                }
            });

            // Reset video preview when switching input types
            if (tabId === 'single') {
                switchVideoTab('input');
            }
        }

        // Add click handlers for input type tabs
        inputTypeTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchInputTypeTab(button.dataset.tab);
            });
        });

        // Initialize with single video input tab
        switchInputTypeTab('single');
    </script>
</body>
</html>